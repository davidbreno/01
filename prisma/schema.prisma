generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MEDICO
  RECEPCAO
}

enum Status {
  AGENDADA
  CONFIRMADA
  CANCELADA
  CONCLUIDA
}

enum DocumentoTipo {
  RECEITA
  PRONTUARIO
  DOCUMENTO_PESSOAL
  RADIOGRAFIA
}

enum ImplanteCategoria {
  CMI
  HE
  HI_TAPA
}

model User {
  id        String    @id @default(cuid())
  name      String
  email     String    @unique
  password  String
  role      Role      @default(RECEPCAO)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  logs      AuditLog[]
  consultas Consulta[] @relation("MedicoConsultas")
  prontuarios Prontuario[] @relation("CriadoPor")
  resetTokens PasswordResetToken[]
}

model Paciente {
  id           String       @id @default(cuid())
  nome         String
  cpf          String       @unique
  nascimento   DateTime
  sexo         String
  telefone     String?
  email        String?
  endereco     String?
  convenio     String?
  carteirinha  String?
  alergias     String?
  observacoes  String?
  arquivado    Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  consultas    Consulta[]
  prontuarios  Prontuario[]
  documentos   PacienteDocumento[]
  anamneses    AnamneseResposta[]
}

model Consulta {
  id         String   @id @default(cuid())
  pacienteId String
  medicoId   String
  inicio     DateTime
  fim        DateTime
  status     Status   @default(AGENDADA)
  notas      String?
  lembreteAtivo Boolean  @default(false)
  lembreteAntecedenciaMinutos Int?
  lembreteEnviadoEm DateTime?
  paciente   Paciente @relation(fields: [pacienteId], references: [id])
  medico     User     @relation("MedicoConsultas", fields: [medicoId], references: [id])
  prontuario Prontuario?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([medicoId, inicio])
  @@index([pacienteId, inicio])
}

model Prontuario {
  id          String      @id @default(cuid())
  pacienteId  String
  consultaId  String? @unique
  criadoPorId String
  conteudo    Json
  paciente    Paciente    @relation(fields: [pacienteId], references: [id])
  consulta    Consulta?   @relation(fields: [consultaId], references: [id])
  criadoPor   User        @relation("CriadoPor", fields: [criadoPorId], references: [id])
  anexos      Attachment[]
  createdAt   DateTime    @default(now())
}

model Attachment {
  id           String     @id @default(cuid())
  prontuarioId String
  url          String
  mime         String
  prontuario   Prontuario @relation(fields: [prontuarioId], references: [id])
  createdAt    DateTime   @default(now())
}

model PacienteDocumento {
  id          String         @id @default(cuid())
  pacienteId  String
  titulo      String
  tipo        DocumentoTipo
  arquivoUrl  String
  arquivoNome String
  mimeType    String
  tamanho     Int
  observacoes String?
  paciente    Paciente       @relation(fields: [pacienteId], references: [id])
  createdAt   DateTime       @default(now())

  @@index([pacienteId, tipo])
}

model AnamnesePergunta {
  id        String             @id @default(cuid())
  pergunta  String
  categoria String?
  ordem     Int                @default(0)
  ativo     Boolean            @default(true)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  respostas AnamneseResposta[]
}

model AnamneseResposta {
  id          String             @id @default(cuid())
  pacienteId  String
  perguntaId  String
  resposta    String
  paciente    Paciente           @relation(fields: [pacienteId], references: [id])
  pergunta    AnamnesePergunta   @relation(fields: [perguntaId], references: [id])
  createdAt   DateTime           @default(now())

  @@unique([pacienteId, perguntaId])
  @@index([perguntaId])
}

model ImplanteEstoqueItem {
  id         String            @id @default(cuid())
  categoria  ImplanteCategoria
  modelo     String
  tamanho    String
  marca      String
  quantidade Int
  imagemUrl  String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
}

model MaterialEstoqueItem {
  id         String   @id @default(cuid())
  nome       String
  categoria  String
  marca      String?
  modelo     String?
  unidade    String?
  quantidade Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String
  before    Json?
  after     Json?
  ip        String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([createdAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
